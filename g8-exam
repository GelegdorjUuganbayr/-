<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>8-—Ä –∞–Ω–≥–∏ ‚Äì CTP –®–∞–ª–≥–∞–ª—Ç (Auto Score)</title>
  <style>
    :root{
      --bg:#0b1220;
      --card:#0f172a;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --accent:#38bdf8;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --line: rgba(148,163,184,.18);
      --white:#fff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1100px 600px at 20% -10%, rgba(56,189,248,.25), transparent 60%),
                  radial-gradient(900px 500px at 90% 0%, rgba(34,197,94,.18), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position: sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(15,23,42,.95), rgba(15,23,42,.75));
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(10px);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px}
    .top{
      display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap;
    }
    .brand{display:flex; flex-direction:column; gap:4px}
    .brand h1{margin:0;font-size:18px; letter-spacing:.2px}
    .brand .sub{font-size:12px;color:var(--muted)}
    .btns{display:flex; gap:8px; flex-wrap:wrap}
    button{
      border: 1px solid var(--line);
      background: rgba(2,6,23,.35);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight:600;
      font-size: 13px;
    }
    button.primary{
      background: rgba(56,189,248,.18);
      border-color: rgba(56,189,248,.45);
    }
    button.good{
      background: rgba(34,197,94,.18);
      border-color: rgba(34,197,94,.45);
    }
    button.danger{
      background: rgba(239,68,68,.14);
      border-color: rgba(239,68,68,.45);
    }
    button:disabled{opacity:.55; cursor:not-allowed}
    main{padding:16px 14px 28px}
    .grid{
      max-width:980px; margin:0 auto;
      display:grid; gap:14px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 920px){
      .grid{grid-template-columns: 1.2fr .8fr; align-items:start;}
    }
    .card{
      background: linear-gradient(180deg, rgba(15,23,42,.92), rgba(2,6,23,.55));
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    .card h2{
      margin:0 0 10px 0;
      font-size: 15px;
      letter-spacing:.2px;
    }
    .muted{color:var(--muted); font-size:12px; line-height:1.4}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    label{font-size:13px}
    input[type="text"], textarea, input[type="date"]{
      width:100%;
      padding: 10px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(2,6,23,.35);
      color: var(--text);
      outline:none;
    }
    textarea{min-height: 86px; resize: vertical}
    .infoRow{
      display:grid; gap:10px; grid-template-columns: 1fr;
    }
    @media (min-width: 520px){
      .infoRow{grid-template-columns: 1.3fr .7fr .7fr}
    }
    .q{
      border-top:1px solid var(--line);
      padding-top:12px; margin-top:12px;
    }
    .q:first-child{border-top:none; padding-top:0; margin-top:0}
    .qtitle{
      font-weight:700;
      font-size: 13.5px;
      margin-bottom: 10px;
      line-height:1.35;
    }
    .opts{
      display:grid; gap:8px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 520px){
      .opts{grid-template-columns: 1fr 1fr}
    }
    .opt{
      display:flex; gap:10px; align-items:flex-start;
      padding: 10px 10px;
      border: 1px solid var(--line);
      border-radius: 14px;
      background: rgba(2,6,23,.26);
    }
    .opt input{transform: translateY(2px)}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(2,6,23,.28);
      font-size:12px; color: var(--muted);
    }
    .pill strong{color:var(--text)}
    .notice{
      border-left: 3px solid rgba(56,189,248,.7);
      padding: 10px 12px;
      background: rgba(56,189,248,.08);
      border-radius: 12px;
      margin-top: 10px;
      font-size: 12.5px;
      color: var(--text);
    }
    .scoreBox{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top: 10px;
    }
    .scoreBig{
      font-size: 26px; font-weight: 900;
    }
    .tag{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid var(--line)}
    .tag.good{border-color: rgba(34,197,94,.55); background: rgba(34,197,94,.12)}
    .tag.warn{border-color: rgba(245,158,11,.55); background: rgba(245,158,11,.12)}
    .tag.bad{border-color: rgba(239,68,68,.55); background: rgba(239,68,68,.12)}
    .list{
      display:flex; flex-direction:column; gap:10px;
      max-height: 62vh; overflow:auto; padding-right: 6px;
    }
    .item{
      border: 1px solid var(--line);
      background: rgba(2,6,23,.28);
      border-radius: 14px;
      padding: 10px;
    }
    .itemTop{display:flex; align-items:center; justify-content:space-between; gap:8px; flex-wrap:wrap}
    .itemName{font-weight:800}
    .mini{font-size:12px; color: var(--muted)}
    .ans{
      margin-top: 8px;
      display:grid; gap:8px;
    }
    .ans .box{
      border:1px dashed rgba(148,163,184,.25);
      border-radius: 12px;
      padding: 8px 10px;
      background: rgba(2,6,23,.18);
      font-size: 12.5px;
      color: var(--text);
      white-space: pre-wrap;
    }
    .hidden{display:none !important}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>8-—Ä –∞–Ω–≥–∏ ‚Äì Computational Thinking & Programming</h1>
        <div class="sub">Front-end auto score ¬∑ –ù—ç–≥ —Ç”©—Ö”©”©—Ä”©–º–∂ –¥—ç—ç—Ä –æ–ª–æ–Ω —Ö“Ø“Ø—Ö—ç–¥ ¬∑ localStorage —Ö–∞–¥–≥–∞–ª–∞–ª—Ç</div>
      </div>
      <div class="btns">
        <button id="btnExam" class="primary" type="button">üìù –®–∞–ª–≥–∞–ª—Ç</button>
        <button id="btnPoints" type="button">üèÅ Points</button>
        <button id="btnNew" class="good" type="button">‚ûï ”®”©—Ä —Ö“Ø“Ø—Ö—ç–¥ —à–∞–ª–≥–∞–ª—Ç ”©–≥”©—Ö</button>
        <button id="btnClearAll" class="danger" type="button">üóëÔ∏è –ë“Ø–≥–¥–∏–π–≥ —É—Å—Ç–≥–∞—Ö</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- EXAM -->
    <section id="examView" class="card">
      <h2>–®–∞–ª–≥–∞–ª—Ç –±”©–≥–ª”©—Ö</h2>
      <div class="muted">
        –ó–∞–∞–≤–∞—Ä: 1‚Äì18 —Ç–µ—Å—Ç (–Ω—ç–≥ –∑”©–≤ —Ö–∞—Ä–∏—É–ª—Ç—Ç–∞–π). –î–∞—Ä–∞–∞—Ö 2 –∑–∞–¥–≥–∞–π –¥–∞–∞–ª–≥–∞–≤—Ä—ã–≥ ”©–≥“Ø“Ø–ª–±—ç—Ä—ç—ç—Ä –≥“Ø–π—Ü—ç—Ç–≥—ç.
      </div>

      <div class="notice">
        ‚úÖ –ù—ç—Ä –∑–∞–∞–≤–∞–ª. ‚úÖ –ë“Ø—Ö —Ç–µ—Å—Ç–∏–π–≥ –±”©–≥–ª”©”©–¥ ‚ÄúSubmit‚Äù –¥–∞—Ä–Ω–∞. –î–∞—Ä–∞–∞ –Ω—å ‚Äú”®”©—Ä —Ö“Ø“Ø—Ö—ç–¥ —à–∞–ª–≥–∞–ª—Ç ”©–≥”©—Ö‚Äù –¥–∞—Ä–∂ –¥–∞—Ä–∞–∞–≥–∏–π–Ω —Ö“Ø“Ø—Ö—ç–¥ ”©–≥–Ω”©.
      </div>

      <div style="margin-top:12px" class="infoRow">
        <div>
          <label><strong>–ù—ç—Ä *</strong></label>
          <input id="studentName" type="text" placeholder="–ñ–∏—à—ç—ç: –ë–∞—Ç-–≠—Ä–¥—ç–Ω—ç" required />
        </div>
        <div>
          <label><strong>–ê–Ω–≥–∏</strong></label>
          <input id="studentClass" type="text" placeholder="–ñ–∏—à—ç—ç: 8A" />
        </div>
        <div>
          <label><strong>–û–≥–Ω–æ–æ</strong></label>
          <input id="examDate" type="date" />
        </div>
      </div>

      <div style="margin-top:12px" class="row">
        <span class="pill">–¢–µ—Å—Ç –±”©–≥–ª”©—Å”©–Ω: <strong id="filledCount">0</strong>/18</span>
        <span class="pill">–°“Ø“Ø–ª–¥ –±–æ–¥—Å–æ–Ω –æ–Ω–æ–æ: <strong id="lastScore">-</strong></span>
      </div>

      <form id="examForm" novalidate style="margin-top:10px">
        <div id="questions"></div>

        <div class="q">
          <div class="qtitle">B. ‚úçÔ∏è –ó–∞–¥–≥–∞–π –¥–∞–∞–ª–≥–∞–≤–∞—Ä (2)</div>

          <label><strong>1) Pseudocode –±–æ–ª–æ–Ω Python –∫–æ–¥—ã–Ω —è–ª–≥–∞–∞–≥ 2‚Äì3 ”©–≥“Ø“Ø–ª–±—ç—Ä—ç—ç—Ä —Ç–∞–π–ª–±–∞—Ä–ª–∞.</strong></label>
          <textarea id="open1" placeholder="–≠–Ω–¥ –±–∏—á–Ω—ç..."></textarea>

          <div style="height:10px"></div>

          <label><strong>2) –§—É–Ω–∫(function) –±–æ–ª–æ–Ω —Å–∞–Ω (library) –≥—ç–∂ —é—É –≤—ç ”©”©—Ä–∏–π–Ω –æ–π–ª–≥–æ—Å–Ω–æ–æ—Ä —Ç–∞–π–ª–±–∞—Ä–ª–∞.</strong></label>
          <textarea id="open2" placeholder="–≠–Ω–¥ –±–∏—á–Ω—ç..."></textarea>
        </div>

        <div class="scoreBox">
          <button id="btnSubmit" class="primary" type="submit">‚úÖ Submit (Auto Score)</button>
          <span class="muted">Submit –¥–∞—Ä–º–∞–≥—Ü —Ö–∞–¥–≥–∞–ª–Ω–∞. Points –¥—ç—ç—Ä –±“Ø–≥–¥ —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞.</span>
        </div>
      </form>
    </section>

    <!-- POINTS -->
    <section id="pointsView" class="card hidden">
      <h2>üèÅ Points (–ù—ç—Ä + –û–Ω–æ–æ + 2 –∑–∞–¥–≥–∞–π —Ö–∞—Ä–∏—É)</h2>
      <div class="muted">–≠–Ω–¥ –Ω—ç–≥ —Ç”©—Ö”©”©—Ä”©–º–∂ –¥—ç—ç—Ä ”©–≥—Å”©–Ω –±“Ø—Ö —Ö“Ø“Ø—Ö–¥–∏–π–Ω “Ø—Ä –¥“Ø–Ω —Ö–∞–¥–≥–∞–ª–∞–≥–¥–∞–Ω–∞.</div>

      <div style="margin-top:10px" class="row">
        <span class="pill">–ù–∏–π—Ç –±“Ø—Ä—Ç–≥—ç–ª: <strong id="totalCount">0</strong></span>
        <span class="pill">–î—É–Ω–¥–∞–∂ –æ–Ω–æ–æ: <strong id="avgScore">-</strong></span>
      </div>

      <div style="margin-top:10px" class="row">
        <button id="btnExport" type="button">‚¨áÔ∏è CSV Export</button>
        <button id="btnCopy" type="button">üìã Copy All</button>
      </div>

      <div style="margin-top:12px" class="list" id="resultsList"></div>
    </section>
  </div>
</main>

<script>
  // ====== CONFIG: Correct answers ======
  // 1..18: B,B,D,B,C,B,C,C,B,B,B,C,B,B,B,B,B,D
  const ANSWER_KEY = {
    1:"B",2:"B",3:"D",4:"B",5:"C",6:"B",7:"C",8:"C",9:"B",
    10:"B",11:"B",12:"C",13:"B",14:"B",15:"B",16:"B",17:"B",18:"D"
  };

  // ====== Questions data ======
  const QUESTIONS = [
    {n:1, t:"Pseudocode –≥—ç–∂ —é—É –≤—ç?", o:{A:"–ü—Ä–æ–≥—Ä–∞–º—á–ª–∞–ª—ã–Ω –±–æ–¥–∏—Ç —Ö—ç–ª",B:"–ê–ª–≥–æ—Ä–∏—Ç–º—ã–≥ —Ç”©–ª”©–≤–ª”©—Ö –±–∏—á–∏–≥–ª—ç–ª",C:"–ó”©–≤—Ö”©–Ω Python –∫–æ–¥",D:"Flowchart-—ã–Ω —Ç”©—Ä”©–ª"}},
    {n:2, t:"Pseudocode-–∏–π–Ω –≥–æ–ª –∑–æ—Ä–∏–ª–≥–æ?", o:{A:"–ö–æ–º–ø—å—é—Ç–µ—Ä—Ç —à—É—É–¥ –∞–∂–∏–ª–ª—É—É–ª–∞—Ö",B:"–ê–ª–≥–æ—Ä–∏—Ç–º—ã–≥ –æ–π–ª–≥–æ–º–∂—Ç–æ–π –±–æ–ª–≥–æ—Ö",C:"–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Ö–∏–π—Ö",D:"–ê–ª–¥–∞–∞ –∑–∞—Å–∞—Ö"}},
    {n:3, t:"–ê–ª—å –Ω—å pseudocode-–¥ input-–≥ –∏–ª—ç—Ä—Ö–∏–π–ª–Ω—ç –≤—ç?", o:{A:"INPUT name",B:"READ name",C:"name = input()",D:"A –±–∞ B"}},
    {n:4, t:"–£—Ç–≥–∞ –æ–Ω–æ–æ—Ö (assignment) —Ç—ç–º–¥—ç–≥?", o:{A:"==",B:"‚Üê —ç—Å–≤—ç–ª =",C:">",D:"!"}},
    {n:5, t:"IF –Ω”©—Ö—Ü”©–ª —è–º–∞—Ä —É—Ç–≥–∞ –±—É—Ü–∞–∞–¥–∞–≥ –≤—ç?", o:{A:"–¢–æ–æ",B:"–¢–µ–∫—Å—Ç",C:"True / False",D:"List"}},
    {n:6, t:"AND –æ–ø–µ—Ä–∞—Ç–æ—Ä —Ö—ç–∑—ç—ç true –≤—ç?", o:{A:"–ù—ç–≥ –Ω—å “Ø–Ω—ç–Ω “Ø–µ–¥",B:"–•–æ—ë—É–ª–∞–∞ “Ø–Ω—ç–Ω “Ø–µ–¥",C:"–•–æ—ë—É–ª–∞–∞ —Ö—É–¥–∞–ª “Ø–µ–¥",D:"–Ø–º–∞—Ä —á “Ø–µ–¥"}},
    {n:7, t:"OR –æ–ø–µ—Ä–∞—Ç–æ—Ä —Ö—ç–∑—ç—ç false –≤—ç?", o:{A:"–ù—ç–≥ –Ω—å “Ø–Ω—ç–Ω “Ø–µ–¥",B:"–•–æ—ë—É–ª–∞–∞ “Ø–Ω—ç–Ω “Ø–µ–¥",C:"–•–æ—ë—É–ª–∞–∞ —Ö—É–¥–∞–ª “Ø–µ–¥",D:"–ù—ç–≥ –Ω—å —Ö—É–¥–∞–ª “Ø–µ–¥"}},
    {n:8, t:"NOT –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã–Ω “Ø“Ø—Ä—ç–≥?", o:{A:"–ù—ç–º—ç—Ö",B:"“Æ—Ä–∂“Ø“Ø–ª—ç—Ö",C:"–£—Ç–≥—ã–≥ —ç—Å—Ä—ç–≥ –±–æ–ª–≥–æ—Ö",D:"–•–∞—Ä—å—Ü—É—É–ª–∞—Ö"}},
    {n:9, t:"IF‚ÄìELSE –±“Ø—Ç—ç—Ü —é—É–Ω–¥ –∞—à–∏–≥–ª–∞–≥–¥–¥–∞–≥ –≤—ç?", o:{A:"–î–∞–≤—Ç–∞–ª—Ç",B:"–°–æ–Ω–≥–æ–ª—Ç",C:"–•–∞–¥–≥–∞–ª–∞–ª—Ç",D:"–•–∞–π–ª—Ç"}},
    {n:10, t:"Linear search –≥—ç–∂ —é—É –≤—ç?", o:{A:"–°–∞–Ω–∞–º—Å–∞—Ä–≥“Ø–π —Ö–∞–π–ª—Ç",B:"–î–∞—Ä–∞–∞–ª–ª–∞–∞—Ä —Ö–∞–π—Ö",C:"–•–æ—ë—Ä —Ö—É–≤–∞–∞–∂ —Ö–∞–π—Ö",D:"–ó”©–≤—Ö”©–Ω —Ö—É—Ä–¥–∞–Ω —Ö–∞–π–ª—Ç"}},
    {n:11, t:"Linear search –∞–ª—å ”©–≥”©–≥–¥”©–ª–¥ —Ç–æ—Ö–∏—Ä–æ–º–∂—Ç–æ–π –≤—ç?", o:{A:"–≠—Ä—ç–º–±—ç–ª—ç–≥–¥—Å—ç–Ω",B:"–≠—Ä—ç–º–±—ç–ª—ç–≥–¥—ç—ç–≥“Ø–π",C:"–ó”©–≤—Ö”©–Ω –∂–∏–∂–∏–≥",D:"–ó”©–≤—Ö”©–Ω —Ç–æ–º"}},
    {n:12, t:"–•–∞–π–∂ –±—É–π —É—Ç–≥–∞ –æ–ª–¥–æ—Ö–≥“Ø–π –±–æ–ª?", o:{A:"–ê–ª–¥–∞–∞ –≥–∞—Ä–Ω–∞",B:"–≠—Ö–Ω–∏–π —É—Ç–≥—ã–≥ –∞–≤–Ω–∞",C:"–ë“Ø—Ö —ç–ª–µ–º–µ–Ω—Ç–∏–π–≥ —à–∞–ª–≥–∞–Ω–∞",D:"–ü—Ä–æ–≥—Ä–∞–º –∑–æ–≥—Å–æ–Ω–æ"}},
    {n:13, t:"Pseudocode —è–∞–≥–∞–∞–¥ language independent –≤—ç?", o:{A:"–ù—ç–≥ —Ö—ç–ª—Ç—ç–π",B:"–Ø–º–∞—Ä —á —Ö—ç–ª–¥ —Ö”©—Ä–≤“Ø“Ø–ª–∂ –±–æ–ª–¥–æ–≥",C:"–ó”©–≤—Ö”©–Ω Python",D:"–ú–∞—à –Ω–∞—Ä–∏–π–Ω syntax-—Ç—ç–π"}},
    {n:14, t:"IF‚ÄìELSEIF‚ÄìELSE –±“Ø—Ç—ç—Ü:", o:{A:"–î–∞–≤—Ç–∞–ª—Ç —Ö–∏–π—Ö—ç–¥",B:"–û–ª–æ–Ω –Ω”©—Ö—Ü”©–ª —à–∞–ª–≥–∞—Ö–∞–¥",C:"–•–∞–π–ª—Ç —Ö–∏–π—Ö—ç–¥",D:"–•—É–≤—å—Å–∞–≥—á –∑–∞—Ä–ª–∞—Ö–∞–¥"}},
    {n:15, t:"Algorithm –≥—ç–¥—ç–≥ –Ω—å:", o:{A:"–ü—Ä–æ–≥—Ä–∞–º",B:"–ê–ª—Ö–∞–º—á–∏–ª—Å–∞–Ω –∑–∞–∞–≤–∞—Ä",C:"–ö–æ–¥—ã–Ω –∞–ª–¥–∞–∞",D:"–ó—É—Ä–∞–≥"}},
    {n:16, t:"Selection –∞–ª—å –æ–π–ª–≥–æ–ª—Ç –≤—ç?", o:{A:"–î–∞–≤—Ç–∞–ª—Ç",B:"–°–æ–Ω–≥–æ–ª—Ç",C:"–î–∞—Ä–∞–∞–ª–∞–ª",D:"–•–∞–π–ª—Ç"}},
    {n:17, t:"Linear search-–∏–π–Ω –¥–∞–≤—É—É —Ç–∞–ª?", o:{A:"–ú–∞—à —Ö—É—Ä–¥–∞–Ω",B:"–≠–Ω–≥–∏–π–Ω, –æ–π–ª–≥–æ–º–∂—Ç–æ–π",C:"–ó–∞–∞–≤–∞–ª —ç—Ä—ç–º–±—ç–ª–Ω—ç",D:"–ú–∞—à —Ç”©–≤”©–≥—Ç—ç–π"}},
    {n:18, t:"prototype –≥—ç–∂ —é—É –≤—ç?", o:{A:"–ê–ª–≥–æ—Ä–∏—Ç–º",B:"–•–∞–π–ª—Ç—ã–Ω –∞—Ä–≥–∞",C:"command",D:"–¢—É—Ä—à–∏–ª—Ç—ã–Ω –∑–∞–≥–≤–∞—Ä"}},
  ];

  // ====== Storage ======
  const STORAGE_KEY = "ctp_exam_results_v1";

  function loadResults(){
    try{
      return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]");
    }catch(e){ return []; }
  }
  function saveResults(arr){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
  }

  // ====== UI refs ======
  const examView = document.getElementById("examView");
  const pointsView = document.getElementById("pointsView");

  const btnExam = document.getElementById("btnExam");
  const btnPoints = document.getElementById("btnPoints");
  const btnNew = document.getElementById("btnNew");
  const btnClearAll = document.getElementById("btnClearAll");

  const questionsEl = document.getElementById("questions");
  const examForm = document.getElementById("examForm");

  const studentName = document.getElementById("studentName");
  const studentClass = document.getElementById("studentClass");
  const examDate = document.getElementById("examDate");

  const filledCount = document.getElementById("filledCount");
  const lastScore = document.getElementById("lastScore");

  const totalCount = document.getElementById("totalCount");
  const avgScore = document.getElementById("avgScore");
  const resultsList = document.getElementById("resultsList");

  const btnExport = document.getElementById("btnExport");
  const btnCopy = document.getElementById("btnCopy");

  // ====== Build Questions ======
  function renderQuestions(){
    questionsEl.innerHTML = "";
    for(const q of QUESTIONS){
      const wrap = document.createElement("div");
      wrap.className = "q";
      wrap.innerHTML = `
        <div class="qtitle">${q.n}. ${escapeHtml(q.t)}</div>
        <div class="opts">
          ${Object.entries(q.o).map(([k,v]) => `
            <label class="opt">
              <input type="radio" name="q${q.n}" value="${k}" />
              <div><strong>${k})</strong> ${escapeHtml(v)}</div>
            </label>
          `).join("")}
        </div>
      `;
      questionsEl.appendChild(wrap);
    }
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // ====== Score ======
  function getSelectedAnswers(){
    const answers = {};
    for(const q of QUESTIONS){
      const checked = document.querySelector(`input[name="q${q.n}"]:checked`);
      answers[q.n] = checked ? checked.value : "";
    }
    return answers;
  }

  function computeScore(ans){
    let score = 0;
    for(let i=1;i<=18;i++){
      if(ans[i] && ans[i] === ANSWER_KEY[i]) score++;
    }
    return score;
  }

  function updateProgress(){
    const ans = getSelectedAnswers();
    const filled = Object.values(ans).filter(v=>v).length;
    filledCount.textContent = filled;
  }

  // ====== Views ======
  function showExam(){
    examView.classList.remove("hidden");
    pointsView.classList.add("hidden");
  }
  function showPoints(){
    examView.classList.add("hidden");
    pointsView.classList.remove("hidden");
    renderPoints();
  }

  // ====== Reset for next student ======
  function resetForm(){
    examForm.reset();
    studentName.value = "";
    studentClass.value = "";
    document.getElementById("open1").value = "";
    document.getElementById("open2").value = "";
    lastScore.textContent = "-";
    updateProgress();
    studentName.focus();
  }

  // ====== Save attempt ======
  function saveAttempt(){
    const name = studentName.value.trim();
    if(!name){
      alert("–ù—ç—Ä –∑–∞–∞–≤–∞–ª –±”©–≥–ª”©–Ω”©!");
      studentName.focus();
      return null;
    }

    const answers = getSelectedAnswers();
    // require all 18 answered
    const missing = [];
    for(let i=1;i<=18;i++){
      if(!answers[i]) missing.push(i);
    }
    if(missing.length){
      alert("–î–∞—Ä–∞–∞—Ö –∞—Å—É—É–ª—Ç—É—É–¥ –¥—É—Ç—É—É –±–∞–π–Ω–∞: " + missing.join(", "));
      return null;
    }

    const score = computeScore(answers);
    const open1 = document.getElementById("open1").value.trim();
    const open2 = document.getElementById("open2").value.trim();
    const cls = studentClass.value.trim();
    const date = examDate.value || new Date().toISOString().slice(0,10);

    const record = {
      id: crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2),
      name,
      class: cls,
      date,
      score,
      outOf: 18,
      answers,
      open1,
      open2,
      ts: Date.now()
    };

    const all = loadResults();
    all.push(record);
    saveResults(all);
    lastScore.textContent = `${score}/18`;
    return record;
  }

  // ====== Points rendering ======
  function scoreTag(score){
    const ratio = score/18;
    if(ratio >= 0.8) return `<span class="tag good">–°–∞–π–Ω</span>`;
    if(ratio >= 0.5) return `<span class="tag warn">–î—É–Ω–¥</span>`;
    return `<span class="tag bad">–°–∞–π–∂—Ä—É—É–ª–∞—Ö</span>`;
  }

  function renderPoints(){
    const all = loadResults().sort((a,b)=>b.ts-a.ts);
    totalCount.textContent = all.length;

    if(all.length){
      const avg = all.reduce((s,x)=>s+x.score,0) / all.length;
      avgScore.textContent = avg.toFixed(2) + "/18";
    } else {
      avgScore.textContent = "-";
    }

    resultsList.innerHTML = "";
    if(!all.length){
      resultsList.innerHTML = `<div class="muted">–û–¥–æ–æ–≥–æ–æ—Ä —Ö–∞–¥–≥–∞–ª—Å–∞–Ω “Ø—Ä –¥“Ø–Ω –∞–ª–≥–∞ –±–∞–π–Ω–∞.</div>`;
      return;
    }

    for(const r of all){
      const item = document.createElement("div");
      item.className = "item";
      item.innerHTML = `
        <div class="itemTop">
          <div>
            <div class="itemName">${escapeHtml(r.name)} ${r.class ? `<span class="mini">(${escapeHtml(r.class)})</span>` : ""}</div>
            <div class="mini">–û–≥–Ω–æ–æ: ${escapeHtml(r.date)} ¬∑ –ë“Ø—Ä—Ç–≥—ç—Å—ç–Ω: ${new Date(r.ts).toLocaleString()}</div>
          </div>
          <div style="display:flex; gap:8px; align-items:center">
            <div class="scoreBig">${r.score}/${r.outOf}</div>
            ${scoreTag(r.score)}
          </div>
        </div>
        <div class="ans">
          <div class="box"><strong>–ó–∞–¥–≥–∞–π 1:</strong>\n${escapeHtml(r.open1 || "(—Ö–æ–æ—Å–æ–Ω)")}</div>
          <div class="box"><strong>–ó–∞–¥–≥–∞–π 2:</strong>\n${escapeHtml(r.open2 || "(—Ö–æ–æ—Å–æ–Ω)")}</div>
        </div>
        <div class="row" style="margin-top:10px">
          <button type="button" data-del="${r.id}">üóëÔ∏è –£—Å—Ç–≥–∞—Ö</button>
          <button type="button" data-copy="${r.id}">üìã Copy</button>
        </div>
      `;
      resultsList.appendChild(item);
    }

    // bind delete/copy
    resultsList.querySelectorAll("button[data-del]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-del");
        const all = loadResults().filter(x=>x.id !== id);
        saveResults(all);
        renderPoints();
      });
    });

    resultsList.querySelectorAll("button[data-copy]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-copy");
        const r = loadResults().find(x=>x.id === id);
        if(!r) return;
        const text =
`Name: ${r.name}
Class: ${r.class || "-"}
Date: ${r.date}
Score: ${r.score}/${r.outOf}

Open 1:
${r.open1 || ""}

Open 2:
${r.open2 || ""}`;
        try{
          await navigator.clipboard.writeText(text);
          alert("–•—É—É–ª–ª–∞–∞!");
        }catch(e){
          prompt("Copy —Ö–∏–π—Ö–∏–π–Ω —Ç—É–ª–¥ –¥–æ–æ—Ä—Ö —Ç–µ–∫—Å—Ç–∏–π–≥ —Ö—É—É–ª:", text);
        }
      });
    });
  }

  // ====== Export / Copy all ======
  function toCSV(rows){
    const esc = (v)=> `"${String(v ?? "").replaceAll('"','""')}"`;
    const header = [
      "name","class","date","score","outOf",
      "open1","open2",
      ...Array.from({length:18},(_,i)=>`q${i+1}`)
    ];
    const lines = [header.map(esc).join(",")];
    for(const r of rows){
      const line = [
        r.name, r.class, r.date, r.score, r.outOf,
        r.open1, r.open2,
        ...Array.from({length:18},(_,i)=> r.answers?.[i+1] || "")
      ];
      lines.push(line.map(esc).join(","));
    }
    return lines.join("\n");
  }

  function download(filename, text){
    const blob = new Blob([text], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // ====== Events ======
  renderQuestions();
  updateProgress();

  questionsEl.addEventListener("change", ()=>{
    updateProgress();
    // optional live score preview (only if all answered) ‚Äî keep simple
  });

  btnExam.addEventListener("click", showExam);
  btnPoints.addEventListener("click", showPoints);

  btnNew.addEventListener("click", ()=>{
    // just reset form for next student
    resetForm();
    showExam();
  });

  btnClearAll.addEventListener("click", ()=>{
    if(confirm("–ë“Ø—Ö —Ö–∞–¥–≥–∞–ª—Å–∞–Ω “Ø—Ä –¥“Ø–Ω–≥ —É—Å—Ç–≥–∞—Ö —É—É?")){
      localStorage.removeItem(STORAGE_KEY);
      renderPoints();
      lastScore.textContent = "-";
      alert("–£—Å—Ç–≥–∞–ª–∞–∞.");
    }
  });

  examForm.addEventListener("submit", (e)=>{
    e.preventDefault();
    const rec = saveAttempt();
    if(!rec) return;
    alert(`–•–∞–¥–≥–∞–ª–ª–∞–∞! –û–Ω–æ–æ: ${rec.score}/18\n–î–∞—Ä–∞–∞–≥–∏–π–Ω —Ö“Ø“Ø—Ö—ç–¥ ‚Äú”®”©—Ä —Ö“Ø“Ø—Ö—ç–¥ —à–∞–ª–≥–∞–ª—Ç ”©–≥”©—Ö‚Äù –¥—ç—ç—Ä –¥–∞—Ä–Ω–∞.`);
    // stay on exam, teacher can press New student
  });

  btnExport.addEventListener("click", ()=>{
    const all = loadResults().sort((a,b)=>a.ts-b.ts);
    const csv = toCSV(all);
    const today = new Date().toISOString().slice(0,10);
    download(`CTP_Exam_Results_${today}.csv`, csv);
  });

  btnCopy.addEventListener("click", async ()=>{
    const all = loadResults().sort((a,b)=>a.ts-b.ts);
    const lines = all.map((r, idx)=>(
`#${idx+1} ${r.name} ${r.class?`(${r.class})`:""} | ${r.date} | ${r.score}/${r.outOf}
Open1: ${r.open1 || ""}
Open2: ${r.open2 || ""}`
    )).join("\n\n---\n\n");
    try{
      await navigator.clipboard.writeText(lines || "");
      alert("–ë“Ø–≥–¥–∏–π–≥ —Ö—É—É–ª–ª–∞–∞!");
    }catch(e){
      prompt("Copy —Ö–∏–π—Ö–∏–π–Ω —Ç—É–ª–¥ –¥–æ–æ—Ä—Ö —Ç–µ–∫—Å—Ç–∏–π–≥ —Ö—É—É–ª:", lines);
    }
  });

  // default date today
  examDate.value = new Date().toISOString().slice(0,10);
</script>
</body>
</html>
