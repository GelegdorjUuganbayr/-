<!doctype html>
<html lang="mn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Statistical Investigation Simulator ‚Äî Managing Data 2.1</title>
  <style>
    :root{
      --bg:#0b1220; --card:#0f1a2f; --text:#eaf1ff; --muted:#a9b7d0;
      --accent:#7dd3fc; --border:rgba(255,255,255,.12);
      --good:#34d399; --bad:#fb7185; --shadow:0 10px 26px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:linear-gradient(180deg,var(--bg),#070b14);color:var(--text);line-height:1.55}
    header{position:sticky;top:0;z-index:10;background:rgba(11,18,32,.9);backdrop-filter:blur(10px);border-bottom:1px solid var(--border)}
    .wrap{max-width:980px;margin:0 auto;padding:14px}
    h1{margin:0;font-size:clamp(16px,3.6vw,22px)}
    .sub{color:var(--muted);font-size:13px;margin-top:4px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .card{background:rgba(15,26,47,.92);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:14px;margin:12px 0}
    .grid{display:grid;gap:12px}
    .two{display:grid;gap:12px;grid-template-columns:1fr}
    @media(min-width:900px){.two{grid-template-columns:1.1fr .9fr}}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .muted{color:var(--muted);font-size:13px}
    .k{font-weight:800}
    select,input[type="text"],input[type="number"],textarea{
      width:100%;padding:10px 12px;border-radius:12px;border:1px solid var(--border);
      background:rgba(255,255,255,.03);color:var(--text);outline:none;font-size:14px
    }
    textarea{min-height:90px;resize:vertical}
    button{
      border:1px solid var(--border);background:rgba(255,255,255,.06);color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800
    }
    button.primary{border-color:rgba(125,211,252,.55);background:rgba(125,211,252,.12)}
    button:disabled{opacity:.55;cursor:not-allowed}
    .stepbar{display:flex;gap:6px;flex-wrap:wrap}
    .step{padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .step.on{border-color:rgba(125,211,252,.55);color:var(--text)}
    .qtitle{font-weight:900;margin:0 0 8px 0}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .box{border:1px dashed var(--border);border-radius:14px;padding:12px;background:rgba(255,255,255,.03)}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top}
    .right{text-align:right}
    .mini{font-size:12px;color:var(--muted)}
    canvas{width:100%;height:260px;border:1px solid var(--border);border-radius:12px;background:rgba(255,255,255,.02)}
    .tag{display:inline-flex;align-items:center;padding:3px 10px;border-radius:999px;border:1px solid var(--border);background:rgba(255,255,255,.03);color:var(--muted);font-size:12px}
    .ok{color:var(--good)} .bad{color:var(--bad)}
    .hidden{display:none}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row">
      <div>
        <h1>–°—É–¥–∞–ª–≥–∞–∞ —Ö–∏–π—Ö Simulation ‚Äî Managing Data 2.1 (Capturing data)</h1>
        <div class="sub">–¢”©–ª”©–≤–ª”©—Ö ‚Üí ”®–≥”©–≥–¥”©–ª —Ü—É–≥–ª—É—É–ª–∞—Ö ‚Üí –®–∏–Ω–∂–ª—ç—Ö ‚Üí –î“Ø–≥–Ω—ç—Ö</div>
      </div>
      <div class="stepbar" id="stepbar"></div>
    </div>
  </div>
</header>

<main class="wrap">
  <section class="card">
    <div class="row">
      <span class="pill">üìå –ó–æ—Ä–∏–ª–≥–æ: ”©”©—Ä—Å–¥”©”© —Å—É–¥–∞–ª–≥–∞–∞–≥–∞–∞ —Ç”©–ª”©–≤–ª”©–∂, ”©–≥”©–≥–¥”©–ª —Ü—É–≥–ª—É—É–ª–∂, –≥—Ä–∞—Ñ–∏–∫/—Ç–æ–æ—Ü–æ–æ–≥–æ–æ—Ä –¥“Ø–≥–Ω—ç–ª—Ç –≥–∞—Ä–≥–∞—Ö</span>
      <span class="pill">üì± –£—Ç—Å–∞–Ω–¥ —Ç–æ—Ö–∏—Ä–æ–º–∂—Ç–æ–π</span>
    </div>
  </section>

  <section class="two">
    <section class="card" id="panel">
      <!-- dynamic step content -->
    </section>

    <aside class="card">
      <div class="qtitle">–¢–æ–≤—á –ª–∞–≤–ª–∞—Ö</div>
      <div class="grid">
        <div class="box">
          <div class="k">”®–≥”©–≥–¥–ª–∏–π–Ω —Ç”©—Ä”©–ª</div>
          <div class="mini">
            <b>Categorical</b> = –∞–Ω–≥–∏–ª–∞–ª/—Ç”©—Ä”©–ª (—É–Ω–¥–∞–∞, ”©–Ω–≥”©) <br>
            <b>Discrete</b> = —Ç–æ–æ–ª–æ–≥–¥–æ—Ö –±“Ø—Ö—ç–ª —Ç–æ–æ (—Ö“Ø–º“Ø“Ø—Å–∏–π–Ω —Ç–æ–æ) <br>
            <b>Continuous</b> = —Ö—ç–º–∂–∏–ª—Ç, –±—É—Ç–∞—Ä—Ö–∞–π –±–∞–π–∂ –±–æ–ª–Ω–æ (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä, –∂–∏–Ω, –∑–∞–π)
          </div>
        </div>
        <div class="box">
          <div class="k">–•—ç—Ä—ç–≥—Å—ç–ª</div>
          <div class="mini">
            <b>Data logger</b> ‚Üí —Ö—É–≥–∞—Ü–∞–∞–Ω—ã —è–≤—Ü–∞–¥ –∞–≤—Ç–æ–º–∞—Ç–∞–∞—Ä —Ö—ç–º–∂–∏–Ω—ç <br>
            <b>Spreadsheet</b> ‚Üí —Ö“Ø—Å–Ω—ç–≥—Ç, —Ç–æ–æ—Ü–æ–æ, –≥—Ä–∞—Ñ–∏–∫ <br>
            <b>Database</b> ‚Üí —Ö–∞–π–ª—Ç/—à“Ø“Ø–ª—Ç (criteria) <br>
            <b>Form</b> ‚Üí –∞—Å—É—É–ª—Ç –±”©–≥–ª“Ø“Ø–ª–∂ ”©–≥”©–≥–¥”©–ª —Ü—É–≥–ª—É—É–ª–Ω–∞ (validation —Ö—ç—Ä—ç–≥–ª—ç–∂ –±–æ–ª–Ω–æ)
          </div>
        </div>
        <div class="box">
          <div class="k">–°–∞–Ω–∞–º–∂</div>
          <div class="mini">
            Continuous —Ñ–æ—Ä–º–¥: <b>—Ö—ç–∑—ç—ç</b>, <b>—Ö–∞–∞–Ω–∞</b>, <b>–Ω—ç–≥–∂</b>, <b>–Ω–∞—Ä–∏–π–≤—á–ª–∞–ª</b> (1‚Äì2 –æ—Ä–Ω—ã –±—É—Ç–∞—Ä—Ö–∞–π) —Ç–æ–¥–æ—Ä—Ö–æ–π –±–∏—á.
          </div>
        </div>
      </div>
    </aside>
  </section>

  <section class="card">
    <div class="row">
      <button id="prevBtn">‚óÄ ”®–º–Ω”©—Ö</button>
      <button class="primary" id="nextBtn">–î–∞—Ä–∞–∞—Ö ‚ñ∂</button>
    </div>
  </section>
</main>

<script>
/* ---------- Steps ---------- */
const STEPS = [
  {id:"pick", name:"1) –°—ç–¥—ç–≤"},
  {id:"plan", name:"2) –¢”©–ª”©–≤–ª”©–≥”©”©"},
  {id:"collect", name:"3) –¶—É–≥–ª—É—É–ª–∞—Ö"},
  {id:"analyze", name:"4) –®–∏–Ω–∂–ª—ç—Ö"},
  {id:"conclude", name:"5) –î“Ø–≥–Ω—ç–ª—Ç"}
];

const INVESTIGATIONS = [
  {
    key:"temp",
    title:"–ê–Ω–≥–∏–π–Ω —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä (”©–¥—Ä–∏–π–Ω —Ç—É—Ä—à)",
    type:"continuous",
    defaultUnit:"¬∞C",
    defaultPrecision:1,
    defaultFrequency: "–•–∏—á—ç—ç–ª –±“Ø—Ä–∏–π–Ω —Ç”©–≥—Å–≥”©–ª",
    recommendedTool:"Data logger —ç—Å–≤—ç–ª —Ç–µ—Ä–º–æ–º–µ—Ç—Ä + —Ö“Ø—Å–Ω—ç–≥—Ç",
    generator: () => {
      // typical school day time points
      const times = ["08:30","09:10","09:50","10:30","11:10","11:50","12:30","13:10","13:50","14:30","15:10"];
      const base = rand(18.5, 22.0);
      const peak = rand(23.0, 27.0);
      const peakIndex = Math.floor(rand(4, 8));
      return times.map((t,i)=>{
        const d = Math.abs(i-peakIndex);
        const temp = (peak - d*rand(0.4,0.9)) + rand(-0.3,0.3);
        const val = clamp(temp, 16, 30);
        return {x:t, y:val};
      });
    }
  },
  {
    key:"plane",
    title:"–¶–∞–∞—Å–∞–Ω –æ–Ω–≥–æ—Ü —Ö–∞–º–≥–∏–π–Ω —Ö–æ–ª –Ω–∏—Å—ç—Ö “Ø“Ø? (3 —É–¥–∞–∞)",
    type:"continuous",
    defaultUnit:"–º",
    defaultPrecision:2,
    defaultFrequency:"–•“Ø–Ω –±“Ø—Ä 3 —É–¥–∞–∞",
    recommendedTool:"–†—É–ª–µ—Ç/–º–µ—Ç—Ä + —Ö“Ø—Å–Ω—ç–≥—Ç",
    generator: () => {
      const students = defaultStudents();
      return students.map(s=>{
        const skill = rand(4, 18); // base meters *0.1
        const a = clamp((skill/10)+rand(-0.35,0.35), 0.5, 4.5);
        const b = clamp((skill/10)+rand(-0.35,0.35), 0.5, 4.5);
        const c = clamp((skill/10)+rand(-0.35,0.35), 0.5, 4.5);
        return {name:s, t1:a, t2:b, t3:c};
      });
    }
  },
  {
    key:"bag",
    title:"–°—É—Ä–≥—É—É–ª–∏–π–Ω —Ü“Ø–Ω—Ö–Ω–∏–π –∂–∏–Ω (–∞–Ω–≥–∏ –¥–æ—Ç–æ—Ä)",
    type:"continuous",
    defaultUnit:"–∫–≥",
    defaultPrecision:1,
    defaultFrequency:"–ù—ç–≥ —É–¥–∞–∞ (–∏–∂–∏–ª –Ω”©—Ö—Ü”©–ª”©”©—Ä)",
    recommendedTool:"–ñ–∏–Ω + —Ö“Ø—Å–Ω—ç–≥—Ç",
    generator: () => {
      const students = defaultStudents();
      return students.map(s=>{
        const w = clamp(rand(1.8, 6.8) + rand(-0.4,0.4), 1.2, 9.5);
        return {name:s, w};
      });
    }
  },
  {
    key:"drink",
    title:"–¶–∞–π–Ω—ã –≥–∞–∑—Ä—ã–Ω —Ö–∞–º–≥–∏–π–Ω –∞–ª–¥–∞—Ä—Ç–∞–π —É–Ω–¥–∞–∞",
    type:"categorical",
    defaultUnit:"‚Äî",
    defaultPrecision:0,
    defaultFrequency:"–ù—ç–≥ —É–¥–∞–∞ (–∞—Å—É—É–ª–≥–∞)",
    recommendedTool:"Online form/Questionnaire + —Ö“Ø—Å–Ω—ç–≥—Ç",
    generator: () => {
      const options = ["–£—Å","–ñ“Ø“Ø—Å","–¶–∞–π","–ö–æ–ª–∞","–°“Ø“Ø"];
      const students = defaultStudents();
      return students.map(s=>{
        const pick = weightedPick(options, [28,20,18,22,12]);
        return {name:s, drink:pick};
      });
    }
  }
];

const state = {
  stepIndex: 0,
  invKey: "temp",
  // planning
  question: "",
  who: "–ú–∞–Ω–∞–π –∞–Ω–≥–∏",
  where: "–°—É—Ä–≥—É—É–ª—å/–∞–Ω–≥–∏",
  when: "",
  frequency: "",
  unit: "",
  precision: 1,
  tool: "",
  // data
  data: null,
  // analysis
  filterValue: "",
  // conclusion
  conclusion: ""
};

const $ = (id)=>document.getElementById(id);

function renderStepbar(){
  const bar = $("stepbar");
  bar.innerHTML = "";
  STEPS.forEach((s,i)=>{
    const el = document.createElement("span");
    el.className = "step" + (i===state.stepIndex ? " on" : "");
    el.textContent = s.name;
    bar.appendChild(el);
  });
}
renderStepbar();

/* ---------- Render Panel ---------- */
function currentInv(){ return INVESTIGATIONS.find(x=>x.key===state.invKey); }

function render(){
  renderStepbar();
  $("prevBtn").disabled = state.stepIndex===0;
  $("nextBtn").textContent = state.stepIndex===STEPS.length-1 ? "–î—É—É—Å–≥–∞—Ö" : "–î–∞—Ä–∞–∞—Ö ‚ñ∂";

  const step = STEPS[state.stepIndex].id;
  const inv = currentInv();
  const panel = $("panel");

  if(step==="pick"){
    panel.innerHTML = `
      <div class="qtitle">1) –°—É–¥–∞–ª–≥–∞–∞–Ω—ã —Å—ç–¥–≤—ç—ç —Å–æ–Ω–≥–æ</div>
      <div class="grid">
        <div>
          <div class="muted">–°—ç–¥—ç–≤</div>
          <select id="invSel">
            ${INVESTIGATIONS.map(x=>`<option value="${x.key}" ${x.key===state.invKey?"selected":""}>${escapeHTML(x.title)}</option>`).join("")}
          </select>
          <div class="hint">–°–æ–Ω–≥–æ—Å–Ω—ã –¥–∞—Ä–∞–∞ —Ç”©–ª”©–≤–ª”©–≥”©”© —Ö—ç—Å—ç–≥—Ç –∞—Å—É—É–ª—Ç–∞–∞ —è–≥ —Ç–∞–≥ –±–æ–ª–≥–æ–Ω–æ.</div>
        </div>
        <div class="box">
          <div class="k">–°–æ–Ω–≥–æ—Å–æ–Ω —Å—ç–¥–≤–∏–π–Ω –º—ç–¥—ç—ç–ª—ç–ª</div>
          <div class="mini">
            <div>”®–≥”©–≥–¥–ª–∏–π–Ω —Ç”©—Ä”©–ª: <span class="tag">${inv.type}</span></div>
            <div style="margin-top:6px">–ó”©–≤–ª”©–º–∂ —Ö—ç—Ä—ç–≥—Å—ç–ª: <b>${escapeHTML(inv.recommendedTool)}</b></div>
          </div>
        </div>
      </div>
    `;
    $("invSel").addEventListener("change", (e)=>{
      state.invKey = e.target.value;
      const inv2 = currentInv();
      // reset defaults
      state.unit = inv2.defaultUnit;
      state.precision = inv2.defaultPrecision;
      state.frequency = inv2.defaultFrequency;
      state.tool = inv2.recommendedTool;
      state.question = "";
      state.when = "";
      state.data = null;
      state.conclusion = "";
      render();
    });
    return;
  }

  if(step==="plan"){
    panel.innerHTML = `
      <div class="qtitle">2) –¢”©–ª”©–≤–ª”©–≥”©”© (–∞—Å—É—É–ª—Ç–∞–∞ —è–≥ —Ç–∞–≥ –±–æ–ª–≥–æ)</div>
      <div class="grid">
        <div class="box">
          <div class="mini"><b>–°—ç–¥—ç–≤:</b> ${escapeHTML(inv.title)}</div>
          <div class="mini"><b>”®–≥”©–≥–¥–ª–∏–π–Ω —Ç”©—Ä”©–ª:</b> <span class="tag">${inv.type}</span></div>
        </div>

        <div>
          <div class="muted">–°—É–¥–∞–ª–≥–∞–∞–Ω—ã –≥–æ–ª –∞—Å—É—É–ª—Ç (1 ”©–≥“Ø“Ø–ª–±—ç—Ä)</div>
          <textarea id="question" placeholder="–ñ: –ú–∞–Ω–∞–π –∞–Ω–≥–∏ ”©–¥”©—Ä—Ç —Ö–∞–º–≥–∏–π–Ω —Ö–∞–ª—É—É–Ω “Ø–µ –Ω—å —Ö—ç–¥—ç–Ω —Ü–∞–≥—Ç –≤—ç?">${escapeHTML(state.question||"")}</textarea>
          <div class="hint">–ê—Å—É—É–ª—Ç –Ω—å —è–≥ —Ö—ç–º–∂–∏—Ö/–∞—Å—É—É—Ö –∑“Ø–π–ª—ç—ç –∑–∞–∞—Å–∞–Ω –±–∞–π—Ö —Ö—ç—Ä—ç–≥—Ç—ç–π.</div>
        </div>

        <div class="two">
          <div>
            <div class="muted">–•—ç–Ω—ç—ç—Å/—é—É–Ω–∞–∞—Å (Who)</div>
            <input id="who" type="text" value="${escapeHTML(state.who)}" />
          </div>
          <div>
            <div class="muted">–•–∞–∞–Ω–∞ (Where)</div>
            <input id="where" type="text" value="${escapeHTML(state.where)}" />
          </div>
        </div>

        <div class="two">
          <div>
            <div class="muted">–•—ç–∑—ç—ç (When)</div>
            <input id="when" type="text" placeholder="–ñ: –î–∞–≤–∞–∞‚Äì–ë–∞–∞—Å–∞–Ω 12:00 —Ü–∞–≥—Ç" value="${escapeHTML(state.when||"")}" />
          </div>
          <div>
            <div class="muted">–•—ç–¥—ç–Ω —É–¥–∞–∞/–¥–∞–≤—Ç–∞–º–∂ (Frequency)</div>
            <input id="freq" type="text" value="${escapeHTML(state.frequency || inv.defaultFrequency)}" />
          </div>
        </div>

        <div class="two">
          <div>
            <div class="muted">–ù—ç–≥–∂ (Unit)</div>
            <input id="unit" type="text" value="${escapeHTML(state.unit || inv.defaultUnit)}" />
          </div>
          <div>
            <div class="muted">–ù–∞—Ä–∏–π–≤—á–ª–∞–ª (–±—É—Ç–∞—Ä—Ö–∞–π –æ—Ä–Ω—ã —Ç–æ–æ)</div>
            <input id="prec" type="number" min="0" max="3" step="1" value="${Number.isFinite(state.precision)?state.precision:inv.defaultPrecision}" />
          </div>
        </div>

        <div>
          <div class="muted">–Ø–º–∞—Ä —Ö—ç—Ä—ç–≥—Å—ç–ª/–∞—Ä–≥–∞ (Tool)</div>
          <input id="tool" type="text" value="${escapeHTML(state.tool || inv.recommendedTool)}" />
        </div>

        <div class="box">
          <div class="k">Form/Validation —Å–∞–Ω–∞–∞</div>
          <div class="mini" id="validationHint"></div>
        </div>
      </div>
    `;

    $("validationHint").innerHTML = buildValidationHint(inv);

    // bind
    $("question").addEventListener("input",(e)=>state.question=e.target.value.trim());
    $("who").addEventListener("input",(e)=>state.who=e.target.value.trim());
    $("where").addEventListener("input",(e)=>state.where=e.target.value.trim());
    $("when").addEventListener("input",(e)=>state.when=e.target.value.trim());
    $("freq").addEventListener("input",(e)=>state.frequency=e.target.value.trim());
    $("unit").addEventListener("input",(e)=>state.unit=e.target.value.trim());
    $("prec").addEventListener("input",(e)=>state.precision=clampInt(e.target.value,0,3));
    $("tool").addEventListener("input",(e)=>state.tool=e.target.value.trim());
    return;
  }

  if(step==="collect"){
    panel.innerHTML = `
      <div class="qtitle">3) ”®–≥”©–≥–¥”©–ª —Ü—É–≥–ª—É—É–ª–∞—Ö (simulation)</div>
      <div class="grid">
        <div class="box">
          <div class="mini"><b>–ê—Å—É—É–ª—Ç:</b> ${escapeHTML(state.question || "‚Äî")}</div>
          <div class="mini"><b>Tool:</b> ${escapeHTML(state.tool || inv.recommendedTool)}</div>
        </div>

        <div class="row">
          <button class="primary" id="genBtn">”®–≥”©–≥–¥”©–ª “Ø“Ø—Å–≥—ç—Ö</button>
          <button id="clearBtn">–¶—ç–≤—ç—Ä–ª—ç—Ö</button>
          <span class="pill">–ù—ç–≥–∂: <b>${escapeHTML(state.unit || inv.defaultUnit)}</b></span>
          <span class="pill">–ù–∞—Ä–∏–π–≤—á–ª–∞–ª: <b>${Number.isFinite(state.precision)?state.precision:inv.defaultPrecision}</b></span>
        </div>

        <div class="box">
          <div class="k">Data table</div>
          <div id="tableArea" class="mini">”®–≥”©–≥–¥”©–ª –∞–ª–≥–∞.</div>
        </div>

        <div class="box">
          <div class="k">CSV (—Ö—É—É–ª–∂ –∞–≤)</div>
          <textarea id="csvArea" readonly placeholder="”®–≥”©–≥–¥”©–ª “Ø“Ø—Å–≥—ç—Å–Ω–∏–π –¥–∞—Ä–∞–∞ —ç–Ω–¥ CSV –≥–∞—Ä–Ω–∞."></textarea>
        </div>
      </div>
    `;

    $("genBtn").addEventListener("click", ()=>{
      state.data = inv.generator();
      renderCollectTable(inv);
    });
    $("clearBtn").addEventListener("click", ()=>{
      state.data = null;
      render();
    });

    // render if already exists
    if(state.data) renderCollectTable(inv);
    return;
  }

  if(step==="analyze"){
    panel.innerHTML = `
      <div class="qtitle">4) –®–∏–Ω–∂–ª—ç—Ö (to–æ—Ü–æ–æ + –≥—Ä–∞—Ñ–∏–∫)</div>
      <div class="grid">
        <div class="box">
          <div class="mini"><b>”®–≥”©–≥–¥–ª–∏–π–Ω —Ç”©—Ä”©–ª:</b> <span class="tag">${inv.type}</span></div>
          <div class="mini"><b>–ù—ç–≥–∂:</b> ${escapeHTML(state.unit||inv.defaultUnit)}</div>
        </div>

        <div class="box" id="analysisBox"></div>

        <div class="box">
          <div class="k">–ì—Ä–∞—Ñ–∏–∫</div>
          <canvas id="chart" width="900" height="260"></canvas>
          <div class="hint">–£—Ç—Å–∞–Ω –¥—ç—ç—Ä —á —Ö–∞—Ä–∞–≥–¥–∞–Ω–∞. (–ï—Ä–¥–∏–π–Ω canvas chart)</div>
        </div>

        <div class="box" id="filterBox"></div>
      </div>
    `;

    if(!state.data){
      $("analysisBox").innerHTML = `<div class="bad">”®–≥”©–≥–¥”©–ª –∞–ª–≥–∞. ‚Äú–¶—É–≥–ª—É—É–ª–∞—Ö‚Äù —Ö—ç—Å—ç–≥ –¥—ç—ç—Ä ”©–≥”©–≥–¥”©–ª “Ø“Ø—Å–≥—ç—ç–¥ –∏—Ä.</div>`;
      $("filterBox").innerHTML = `<div class="muted">”®–≥”©–≥–¥”©–ª –±–∞–π—Ö–≥“Ø–π —Ç—É–ª —à“Ø“Ø–ª—Ç —Ö–∏–π—Ö –±–æ–ª–æ–º–∂–≥“Ø–π.</div>`;
      clearCanvas($("chart"));
      return;
    }

    runAnalysis(inv);
    return;
  }

  if(step==="conclude"){
    panel.innerHTML = `
      <div class="qtitle">5) –î“Ø–≥–Ω—ç–ª—Ç –±–∏—á</div>
      <div class="grid">
        <div class="box">
          <div class="mini"><b>–ê—Å—É—É–ª—Ç:</b> ${escapeHTML(state.question || "‚Äî")}</div>
          <div class="mini"><b>”®–≥”©–≥–¥–ª–∏–π–Ω —Ç”©—Ä”©–ª:</b> <span class="tag">${inv.type}</span></div>
        </div>

        <div>
          <div class="muted">–î“Ø–≥–Ω—ç–ª—Ç (3‚Äì5 ”©–≥“Ø“Ø–ª–±—ç—Ä)</div>
          <textarea id="conc" placeholder="–ñ: –î—É–Ω–¥–∞–∂ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä ... –•–∞–º–≥–∏–π–Ω ”©–Ω–¥”©—Ä –Ω—å ... “Ø–µ–¥ –±–∞–π—Å–∞–Ω. “Æ“Ø–Ω–∏–π —à–∞–ª—Ç–≥–∞–∞–Ω –Ω—å ... –±–∞–π–∂ –º–∞–≥–∞–¥–≥“Ø–π. –î–∞—Ä–∞–∞–≥–∏–π–Ω —É–¥–∞–∞ ...">${escapeHTML(state.conclusion||"")}</textarea>
          <div class="hint">–î“Ø–≥–Ω—ç–ª—Ç–¥—ç—ç: (1) –≥–æ–ª “Ø—Ä –¥“Ø–Ω, (2) –±–∞—Ç–∞–ª–≥–∞–∞ (—Ç–æ–æ/–≥—Ä–∞—Ñ–∏–∫), (3) –±–æ–ª–æ–º–∂–∏—Ç —à–∞–ª—Ç–≥–∞–∞–Ω, (4) —Å–∞–π–∂—Ä—É—É–ª–∞—Ö —Å–∞–Ω–∞–ª.</div>
        </div>

        <div class="box">
          <div class="k">Export</div>
          <div class="row">
            <button id="copyPlanBtn">–¢”©–ª”©–≤–ª”©–≥”©”©–≥ —Ö—É—É–ª</button>
            <button id="copyConcBtn">–î“Ø–≥–Ω—ç–ª—Ç–∏–π–≥ —Ö—É—É–ª</button>
          </div>
          <div class="hint" id="copyMsg" style="display:none"></div>
        </div>
      </div>
    `;

    $("conc").addEventListener("input",(e)=>state.conclusion=e.target.value);

    $("copyPlanBtn").addEventListener("click", async ()=>{
      const txt = buildPlanText();
      await copyText(txt);
      showCopy("–¢”©–ª”©–≤–ª”©–≥”©”© —Ö—É—É–ª—Å–∞–Ω.");
    });
    $("copyConcBtn").addEventListener("click", async ()=>{
      await copyText(state.conclusion||"");
      showCopy("–î“Ø–≥–Ω—ç–ª—Ç —Ö—É—É–ª—Å–∞–Ω.");
    });
    return;
  }
}

function buildValidationHint(inv){
  if(inv.type==="categorical"){
    return `Categorical ”©–≥”©–≥–¥”©–ª: <b>—Å–æ–Ω–≥–æ–ª—Ç—Ç–æ–π</b> (multiple choice) –∞—Å—É—É–ª—Ç —Ç–æ—Ö–∏—Ä–æ–º–∂—Ç–æ–π. –ñ: ‚Äú–î—É—Ä—Ç–∞–π —É–Ω–¥–∞–∞‚Äù ‚Üí —Å–æ–Ω–≥–æ–ª—Ç—É—É–¥.`;
  }
  return `Continuous ”©–≥”©–≥–¥”©–ª: –∑”©–≤—Ö”©–Ω <b>—Ç–æ–æ</b> –æ—Ä—É—É–ª–∞—Ö, –±–æ–ª–æ–º–∂–∏—Ç <b>–¥–∏–∞–ø–∞–∑–æ–Ω</b> —Ç–æ–≥—Ç–æ–æ—Ö, ${escapeHTML(state.unit||inv.defaultUnit)} <b>–Ω—ç–≥–∂</b> –∑–∞–∞—Ö, <b>${Number.isFinite(state.precision)?state.precision:inv.defaultPrecision}</b> –æ—Ä–Ω—ã –±—É—Ç–∞—Ä—Ö–∞–π–≥–∞–∞—Ä —Ö“Ø–ª—ç—ç–Ω –∞–≤–∞—Ö –≥—ç—Ö –º—ç—Ç validation —Ç–∞–≤—å–∂ –±–æ–ª–Ω–æ.`;
}

/* ---------- Collect Table + CSV ---------- */
function renderCollectTable(inv){
  const area = $("tableArea");
  const csvArea = $("csvArea");
  if(!state.data){
    area.textContent = "”®–≥”©–≥–¥”©–ª –∞–ª–≥–∞.";
    csvArea.value = "";
    return;
  }

  let html = "";
  let csv = "";

  if(inv.key==="temp"){
    html = `<table><thead><tr><th>–¶–∞–≥</th><th class="right">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä (${escapeHTML(state.unit||"¬∞C")})</th></tr></thead><tbody>${
      state.data.map(r=>`<tr><td>${escapeHTML(r.x)}</td><td class="right">${fmt(r.y)}</td></tr>`).join("")
    }</tbody></table>`;
    csv = "time,temperature\n" + state.data.map(r=>`${r.x},${fmtRaw(r.y)}`).join("\n");
  }

  if(inv.key==="plane"){
    html = `<table><thead><tr><th>–ù—ç—Ä</th><th class="right">1 (${escapeHTML(state.unit||"–º")})</th><th class="right">2</th><th class="right">3</th></tr></thead><tbody>${
      state.data.map(r=>`<tr><td>${escapeHTML(r.name)}</td><td class="right">${fmt(r.t1)}</td><td class="right">${fmt(r.t2)}</td><td class="right">${fmt(r.t3)}</td></tr>`).join("")
    }</tbody></table>`;
    csv = "name,try1,try2,try3\n" + state.data.map(r=>`${safeCSV(r.name)},${fmtRaw(r.t1)},${fmtRaw(r.t2)},${fmtRaw(r.t3)}`).join("\n");
  }

  if(inv.key==="bag"){
    html = `<table><thead><tr><th>–ù—ç—Ä</th><th class="right">–ñ–∏–Ω (${escapeHTML(state.unit||"–∫–≥")})</th></tr></thead><tbody>${
      state.data.map(r=>`<tr><td>${escapeHTML(r.name)}</td><td class="right">${fmt(r.w)}</td></tr>`).join("")
    }</tbody></table>`;
    csv = "name,weight\n" + state.data.map(r=>`${safeCSV(r.name)},${fmtRaw(r.w)}`).join("\n");
  }

  if(inv.key==="drink"){
    html = `<table><thead><tr><th>–ù—ç—Ä</th><th>–£–Ω–¥–∞–∞</th></tr></thead><tbody>${
      state.data.map(r=>`<tr><td>${escapeHTML(r.name)}</td><td>${escapeHTML(r.drink)}</td></tr>`).join("")
    }</tbody></table>`;
    csv = "name,drink\n" + state.data.map(r=>`${safeCSV(r.name)},${safeCSV(r.drink)}`).join("\n");
  }

  area.innerHTML = html;
  csvArea.value = csv;
}

/* ---------- Analysis ---------- */
function runAnalysis(inv){
  const analysisBox = $("analysisBox");
  const filterBox = $("filterBox");
  const canvas = $("chart");
  clearCanvas(canvas);

  if(inv.key==="temp"){
    const ys = state.data.map(r=>r.y);
    const min = Math.min(...ys), max = Math.max(...ys), avg = mean(ys);
    const minT = state.data[ys.indexOf(min)].x;
    const maxT = state.data[ys.indexOf(max)].x;

    analysisBox.innerHTML = `
      <div class="k">–¢–æ–æ—Ü–æ–æ</div>
      <div class="mini">–î—É–Ω–¥–∞–∂: <b>${fmt(avg)}</b> ${escapeHTML(state.unit||"¬∞C")}</div>
      <div class="mini">–•–∞–º–≥–∏–π–Ω –±–∞–≥–∞: <b>${fmt(min)}</b> (${escapeHTML(minT)})</div>
      <div class="mini">–•–∞–º–≥–∏–π–Ω –∏—Ö: <b>${fmt(max)}</b> (${escapeHTML(maxT)})</div>
      <div class="mini">–•—ç–ª–±—ç–ª–∑—ç–ª (max-min): <b>${fmt(max-min)}</b></div>
    `;
    drawLine(canvas, state.data.map(r=>r.x), ys, `–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä (${escapeHTML(state.unit||"¬∞C")})`);
    filterBox.innerHTML = `<div class="muted">Continuous ”©–≥”©–≥–¥”©–ª –¥—ç—ç—Ä —à“Ø“Ø–ª—Ç (criteria)-–∏–π–Ω –æ—Ä–æ–Ω–¥ ‚Äú—Ö–∞–º–≥–∏–π–Ω –∏—Ö/–±–∞–≥–∞‚Äù, ‚Äú–¥—É–Ω–¥–∞–∂‚Äù –≥—ç—Ö –º—ç—Ç –¥“Ø–≥–Ω—ç–ª—Ç —Ö–∏–π–∂ –±–æ–ª–Ω–æ.</div>`;
  }

  if(inv.key==="plane"){
    const rows = state.data.map(r=>{
      const best = Math.max(r.t1,r.t2,r.t3);
      const avg = (r.t1+r.t2+r.t3)/3;
      return {name:r.name, best, avg};
    });
    rows.sort((a,b)=>b.best-a.best);
    const bestOne = rows[0];

    analysisBox.innerHTML = `
      <div class="k">–¢–æ–æ—Ü–æ–æ</div>
      <div class="mini">–•“Ø–Ω –±“Ø—Ä–∏–π–Ω ‚Äúbest‚Äù (3 –æ—Ä–æ–ª–¥–ª–æ–≥—ã–Ω —Ö–∞–º–≥–∏–π–Ω –∏—Ö) –±–∞ ‚Äúaverage‚Äù —Ç–æ–æ—Ü–ª–æ–æ.</div>
      <div class="mini">–•–∞–º–≥–∏–π–Ω —Å–∞–π–Ω: <b>${escapeHTML(bestOne.name)}</b> ‚Äî best <b>${fmt(bestOne.best)}</b> ${escapeHTML(state.unit||"–º")}</div>
      <div class="mini">–°–∞–Ω–∞–ª: best-—ç—ç—Ä —ç—Ä—ç–º–±—ç–ª—ç—Ö –Ω—å ‚Äú—Ö–∞–º–≥–∏–π–Ω —Ö–æ–ª –Ω–∏—Å—Å—ç–Ω‚Äù –∞—Å—É—É–ª—Ç–∞–¥ —Ç–æ—Ö–∏—Ä–æ–º–∂—Ç–æ–π.</div>
    `;

    const labels = rows.slice(0,8).map(r=>r.name);
    const vals = rows.slice(0,8).map(r=>r.best);
    drawBar(canvas, labels, vals, `Best –∑–∞–π (${escapeHTML(state.unit||"–º")})`);

    filterBox.innerHTML = `
      <div class="k">Criteria (—à“Ø“Ø–ª—Ç)</div>
      <div class="mini">–ñ: best ‚â• —Ç–æ–¥–æ—Ä—Ö–æ–π —É—Ç–≥–∞</div>
      <div class="row" style="margin-top:8px">
        <input id="thresh" type="number" step="0.1" placeholder="–ñ: 2.5" style="max-width:220px">
        <button id="applyThresh" class="primary">–®“Ø“Ø—Ö</button>
      </div>
      <div id="threshOut" class="mini" style="margin-top:10px"></div>
    `;

    $("applyThresh").addEventListener("click", ()=>{
      const th = parseFloat($("thresh").value);
      if(!Number.isFinite(th)){ $("threshOut").innerHTML = `<span class="bad">–¢–æ–æ–Ω –±–æ—Å–≥–æ –æ—Ä—É—É–ª.</span>`; return; }
      const hit = rows.filter(r=>r.best >= th);
      $("threshOut").innerHTML = hit.length
        ? `<b>${hit.length}</b> —Ö“Ø–Ω best ‚â• ${fmt(th)}: ${hit.map(x=>escapeHTML(x.name)).join(", ")}`
        : `–ò–π–º —Ö“Ø–Ω –æ–ª–¥—Å–æ–Ω–≥“Ø–π.`;
    });
  }

  if(inv.key==="bag"){
    const rows = state.data.map(r=>r.w);
    const min = Math.min(...rows), max = Math.max(...rows), avg = mean(rows);
    const maxName = state.data[rows.indexOf(max)].name;
    const minName = state.data[rows.indexOf(min)].name;

    analysisBox.innerHTML = `
      <div class="k">–¢–æ–æ—Ü–æ–æ</div>
      <div class="mini">–î—É–Ω–¥–∞–∂ –∂–∏–Ω: <b>${fmt(avg)}</b> ${escapeHTML(state.unit||"–∫–≥")}</div>
      <div class="mini">–•–∞–º–≥–∏–π–Ω —Ö“Ø–Ω–¥: <b>${escapeHTML(maxName)}</b> ‚Äî <b>${fmt(max)}</b></div>
      <div class="mini">–•–∞–º–≥–∏–π–Ω —Ö”©–Ω–≥”©–Ω: <b>${escapeHTML(minName)}</b> ‚Äî <b>${fmt(min)}</b></div>
      <div class="mini">–•—ç–ª–±—ç–ª–∑—ç–ª: <b>${fmt(max-min)}</b></div>
    `;

    // bar chart top 8 heaviest
    const sorted = state.data.slice().sort((a,b)=>b.w-a.w).slice(0,8);
    drawBar(canvas, sorted.map(x=>x.name), sorted.map(x=>x.w), `–ñ–∏–Ω (${escapeHTML(state.unit||"–∫–≥")})`);

    filterBox.innerHTML = `
      <div class="k">Criteria (—à“Ø“Ø–ª—Ç)</div>
      <div class="mini">–ñ: –∂–∏–Ω ‚â• –±–æ—Å–≥–æ</div>
      <div class="row" style="margin-top:8px">
        <input id="wth" type="number" step="0.1" placeholder="–ñ: 5.0" style="max-width:220px">
        <button id="applyW" class="primary">–®“Ø“Ø—Ö</button>
      </div>
      <div id="wOut" class="mini" style="margin-top:10px"></div>
    `;
    $("applyW").addEventListener("click", ()=>{
      const th = parseFloat($("wth").value);
      if(!Number.isFinite(th)){ $("wOut").innerHTML = `<span class="bad">–¢–æ–æ–Ω –±–æ—Å–≥–æ –æ—Ä—É—É–ª.</span>`; return; }
      const hit = state.data.filter(r=>r.w >= th);
      $("wOut").innerHTML = hit.length
        ? `<b>${hit.length}</b> —Ö“Ø–Ω –∂–∏–Ω ‚â• ${fmt(th)}: ${hit.map(x=>escapeHTML(x.name)).join(", ")}`
        : `–ò–π–º —Ö“Ø–Ω –æ–ª–¥—Å–æ–Ω–≥“Ø–π.`;
    });
  }

  if(inv.key==="drink"){
    // count categories
    const counts = {};
    state.data.forEach(r=>counts[r.drink]=(counts[r.drink]||0)+1);
    const items = Object.entries(counts).sort((a,b)=>b[1]-a[1]);
    const top = items[0];

    analysisBox.innerHTML = `
      <div class="k">–¢–æ–æ—Ü–æ–æ</div>
      <div class="mini">–ù–∏–π—Ç —Ö–∞—Ä–∏—É–ª—Ç: <b>${state.data.length}</b></div>
      <div class="mini">–•–∞–º–≥–∏–π–Ω –æ–ª–æ–Ω: <b>${escapeHTML(top[0])}</b> ‚Äî <b>${top[1]}</b> —Ö“Ø–Ω</div>
    `;
    drawBar(canvas, items.map(x=>x[0]), items.map(x=>x[1]), "–°–æ–Ω–≥–æ–ª—Ç—ã–Ω —Ç–æ–æ");

    filterBox.innerHTML = `
      <div class="k">Criteria (—à“Ø“Ø–ª—Ç)</div>
      <div class="mini">–ñ: —É–Ω–¥–∞–∞ = ‚Äú–£—Å‚Äù –≥—ç—Ö –º—ç—Ç—ç—ç—Ä —à“Ø“Ø—Ö</div>
      <div class="row" style="margin-top:8px">
        <select id="drinkSel" style="max-width:260px">
          ${items.map(x=>`<option value="${escapeAttr(x[0])}">${escapeHTML(x[0])}</option>`).join("")}
        </select>
        <button id="applyDrink" class="primary">–®“Ø“Ø—Ö</button>
      </div>
      <div id="drinkOut" class="mini" style="margin-top:10px"></div>
    `;
    $("applyDrink").addEventListener("click", ()=>{
      const v = $("drinkSel").value;
      const hit = state.data.filter(r=>r.drink===v).map(r=>r.name);
      $("drinkOut").innerHTML = hit.length
        ? `<b>${hit.length}</b> —Ö“Ø–Ω "${escapeHTML(v)}" —Å–æ–Ω–≥–æ—Å–æ–Ω: ${hit.map(n=>escapeHTML(n)).join(", ")}`
        : `–û–ª–¥—Å–æ–Ω–≥“Ø–π.`;
    });
  }
}

/* ---------- Charts (simple canvas) ---------- */
function clearCanvas(c){
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);
  ctx.fillStyle = "rgba(255,255,255,.02)";
  ctx.fillRect(0,0,c.width,c.height);
}

function drawAxes(ctx, w, h){
  const pad = 46;
  ctx.strokeStyle = "rgba(255,255,255,.15)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(pad, 12);
  ctx.lineTo(pad, h-pad);
  ctx.lineTo(w-12, h-pad);
  ctx.stroke();
  return {pad};
}

function drawLine(canvas, labels, values, title){
  const ctx = canvas.getContext("2d");
  clearCanvas(canvas);
  const w=canvas.width, h=canvas.height;
  const {pad} = drawAxes(ctx,w,h);

  const min = Math.min(...values), max = Math.max(...values);
  const range = (max-min) || 1;
  const n = values.length;

  // title
  ctx.fillStyle = "rgba(234,241,255,.92)";
  ctx.font = "bold 14px system-ui";
  ctx.fillText(title, pad, 22);

  // grid lines + y labels (5)
  ctx.font = "12px system-ui";
  for(let i=0;i<=4;i++){
    const y = 12 + (h-pad-12)*(i/4);
    const val = (max - range*(i/4));
    ctx.strokeStyle = "rgba(255,255,255,.08)";
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(w-12,y); ctx.stroke();
    ctx.fillStyle = "rgba(255,255,255,.6)";
    ctx.fillText(fmt(val), 8, y+4);
  }

  // x labels (every ~2)
  const step = Math.ceil(n/6);
  for(let i=0;i<n;i+=step){
    const x = pad + (w-12-pad)*(i/(n-1||1));
    ctx.fillStyle = "rgba(255,255,255,.55)";
    ctx.fillText(labels[i], x-14, h-pad+18);
  }

  // line
  ctx.strokeStyle = "rgba(125,211,252,.85)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  values.forEach((v,i)=>{
    const x = pad + (w-12-pad)*(i/(n-1||1));
    const y = 12 + (h-pad-12)*((max - v)/range);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  });
  ctx.stroke();

  // points
  ctx.fillStyle = "rgba(125,211,252,.9)";
  values.forEach((v,i)=>{
    const x = pad + (w-12-pad)*(i/(n-1||1));
    const y = 12 + (h-pad-12)*((max - v)/range);
    ctx.beginPath(); ctx.arc(x,y,3,0,Math.PI*2); ctx.fill();
  });
}

function drawBar(canvas, labels, values, title){
  const ctx = canvas.getContext("2d");
  clearCanvas(canvas);
  const w=canvas.width, h=canvas.height;
  const {pad} = drawAxes(ctx,w,h);

  const max = Math.max(...values) || 1;
  const n = values.length;
  const barW = (w-12-pad)/Math.max(n,1);

  ctx.fillStyle = "rgba(234,241,255,.92)";
  ctx.font = "bold 14px system-ui";
  ctx.fillText(title, pad, 22);

  // y grid lines
  ctx.font = "12px system-ui";
  for(let i=0;i<=4;i++){
    const y = 12 + (h-pad-12)*(i/4);
    const val = max - max*(i/4);
    ctx.strokeStyle = "rgba(255,255,255,.08)";
    ctx.beginPath(); ctx.moveTo(pad,y); ctx.lineTo(w-12,y); ctx.stroke();
    ctx.fillStyle = "rgba(255,255,255,.6)";
    ctx.fillText((val%1===0?val.toFixed(0):val.toFixed(1)), 8, y+4);
  }

  // bars
  for(let i=0;i<n;i++){
    const v = values[i];
    const x0 = pad + i*barW + 6;
    const x1 = pad + (i+1)*barW - 6;
    const bw = Math.max(6, x1-x0);
    const y = 12 + (h-pad-12)*(1 - v/max);
    const base = h-pad;

    ctx.fillStyle = "rgba(125,211,252,.75)";
    ctx.fillRect(x0, y, bw, base-y);

    ctx.fillStyle = "rgba(255,255,255,.55)";
    const lab = labels[i].length>10 ? labels[i].slice(0,10)+"‚Ä¶" : labels[i];
    ctx.fillText(lab, x0, h-pad+18);
  }
}

/* ---------- Navigation ---------- */
$("prevBtn").addEventListener("click", ()=>{
  if(state.stepIndex>0){ state.stepIndex--; render(); }
});
$("nextBtn").addEventListener("click", ()=>{
  if(state.stepIndex<STEPS.length-1){
    // simple guard: plan requires question
    if(STEPS[state.stepIndex].id==="plan" && !state.question.trim()){
      alert("–°—É–¥–∞–ª–≥–∞–∞–Ω—ã –≥–æ–ª –∞—Å—É—É–ª—Ç–∞–∞ –±–∏—á.");
      return;
    }
    if(STEPS[state.stepIndex].id==="collect" && !state.data){
      alert("”®–≥”©–≥–¥”©–ª “Ø“Ø—Å–≥—ç—ç–¥ –¥–∞—Ä–∞–∞ –Ω—å —à–∏–Ω–∂–∏–ª–≥—ç—ç —Ä“Ø“Ø –æ—Ä.");
      return;
    }
    state.stepIndex++;
    render();
    window.scrollTo({top:0,behavior:"smooth"});
  }else{
    alert("–î—É—É—Å–ª–∞–∞. –î“Ø–≥–Ω—ç–ª—Ç–∏–π–≥ —Ö—É—É–ª–∂ –∞–≤–∞–∞–¥ –¥—ç–≤—Ç—ç—Ä—Ç—ç—ç –±–∏—á–∏–∂ –±–æ–ª–Ω–æ.");
  }
});

render(); // initial

/* ---------- Utils ---------- */
function rand(a,b){ return a + Math.random()*(b-a); }
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function clampInt(v,a,b){
  const n = parseInt(v,10);
  if(!Number.isFinite(n)) return a;
  return Math.max(a, Math.min(b,n));
}
function mean(arr){ return arr.reduce((s,x)=>s+x,0)/(arr.length||1); }
function fmt(x){
  const p = Number.isFinite(state.precision)?state.precision:1;
  return Number(x).toFixed(p);
}
function fmtRaw(x){
  const p = Number.isFinite(state.precision)?state.precision:1;
  return Number(x).toFixed(p);
}
function defaultStudents(){
  return ["–ê–Ω—É","–ë–∞—Ç","–°–∞—Ä—É—É–ª","–¢—ç–º“Ø“Ø–∂–∏–Ω","–ù–æ–º–∏–Ω","–≠–Ω—Ö–∂–∏–Ω","–ë–∏–ª–≥“Ø“Ø–Ω","–•—É–ª–∞–Ω","–û–¥","–ú–∞—Ä–∞–ª","–¢”©–≥”©–ª–¥”©—Ä","–¶—ç–ª–º—ç–≥"];
}
function weightedPick(items, weights){
  const sum = weights.reduce((s,x)=>s+x,0);
  let r = Math.random()*sum;
  for(let i=0;i<items.length;i++){
    r -= weights[i];
    if(r<=0) return items[i];
  }
  return items[items.length-1];
}
function safeCSV(s){
  const t = String(s??"");
  if(/[,"\n]/.test(t)) return `"${t.replace(/"/g,'""')}"`;
  return t;
}
function escapeHTML(s){
  return String(s??"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m]));
}
function escapeAttr(s){
  return String(s??"").replace(/"/g,"&quot;");
}

function buildPlanText(){
  const inv = currentInv();
  return [
    `–°—ç–¥—ç–≤: ${inv.title}`,
    `”®–≥”©–≥–¥–ª–∏–π–Ω —Ç”©—Ä”©–ª: ${inv.type}`,
    `–ê—Å—É—É–ª—Ç: ${state.question || "-"}`,
    `Who: ${state.who || "-"}`,
    `Where: ${state.where || "-"}`,
    `When: ${state.when || "-"}`,
    `Frequency: ${state.frequency || "-"}`,
    `Unit: ${state.unit || "-"}`,
    `Precision: ${Number.isFinite(state.precision)?state.precision:"-"}`,
    `Tool: ${state.tool || "-"}`
  ].join("\n");
}
async function copyText(txt){
  try{ await navigator.clipboard.writeText(txt); }
  catch(e){
    const ta = document.createElement("textarea");
    ta.value = txt; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    document.body.removeChild(ta);
  }
}
function showCopy(msg){
  const el = $("copyMsg");
  el.style.display = "block";
  el.textContent = msg;
  setTimeout(()=>el.style.display="none", 1400);
}
</script>
</body>
</html>
